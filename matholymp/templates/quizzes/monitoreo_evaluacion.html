{% extends 'base.html' %}
{% block sidebar %}
    {% include 'quizzes/sidebar.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header del monitoreo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-0">
                                <i class="bi bi-eye-fill"></i>
                                Monitoreo en Tiempo Real
                            </h2>
                            <p class="mb-0 mt-2">
                                <strong>{{ evaluacion.title }}</strong> - {{ evaluacion.get_etapa_display }}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex justify-content-end align-items-center">
                                <div class="me-3">
                                    <small>Última actualización:</small><br>
                                    <span id="last-update">Cargando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas generales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ participantes_activos }}</h3>
                    <p class="mb-0">Activos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ participantes_pendientes }}</h3>
                    <p class="mb-0">Pendientes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ participantes_finalizados }}</h3>
                    <p class="mb-0">Finalizados</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ total_participantes }}</h3>
                    <p class="mb-0">Total</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de monitoreo -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-people-fill"></i>
                        Participantes en Evaluación
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tabla-monitoreo">
                            <thead class="table-dark">
                                <tr>
                                    <th>Participante</th>
                                    <th>Estado</th>
                                    <th>Intentos</th>
                                    <th>Progreso/Puntaje</th>
                                    <th>Alertas</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-monitoreo">
                                <!-- Los datos se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para finalizar evaluación -->
<div class="modal fade" id="modalFinalizar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i>
                    Finalizar Evaluación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>¿Estás seguro de que deseas finalizar la evaluación de <span id="participante-nombre"></span>?</strong></p>
                <p class="text-muted">Esta acción no se puede deshacer.</p>
                <div class="mb-3">
                    <label for="motivo-finalizacion" class="form-label">Motivo de la finalización:</label>
                    <textarea class="form-control" id="motivo-finalizacion" rows="3" placeholder="Describa el motivo de la finalización..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btn-confirmar-finalizar">
                    <i class="bi bi-stop-circle"></i>
                    Finalizar Evaluación
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar alerta -->
<div class="modal fade" id="modalAlerta" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i>
                    Agregar Alerta
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="tipo-alerta" class="form-label">Tipo de Alerta:</label>
                    <select class="form-select" id="tipo-alerta">
                        <option value="comportamiento">Comportamiento Sospechoso</option>
                        <option value="tecnico">Problema Técnico</option>
                        <option value="conexion">Problema de Conexión</option>
                        <option value="inactividad">Inactividad Prolongada</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="severidad-alerta" class="form-label">Severidad:</label>
                    <select class="form-select" id="severidad-alerta">
                        <option value="baja">Baja</option>
                        <option value="media">Media</option>
                        <option value="alta">Alta</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="descripcion-alerta" class="form-label">Descripción:</label>
                    <textarea class="form-control" id="descripcion-alerta" rows="3" placeholder="Describa la alerta..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btn-confirmar-alerta">
                    <i class="bi bi-plus-circle"></i>
                    Agregar Alerta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles -->
<div class="modal fade" id="modalDetalles" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i>
                    Detalles del Monitoreo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detalles-contenido">
                <!-- Los detalles se cargarán dinámicamente -->
            </div>
        </div>
    </div>
</div>

<!-- Modal para gestionar intentos -->
<div class="modal fade" id="modalIntentos" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-repeat"></i>
                    Gestionar Intentos
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6><strong>Participante:</strong> <span id="intentos-participante-nombre"></span></h6>
                    <p class="text-muted mb-1">Cédula: <span id="intentos-participante-cedula"></span></p>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h5 class="card-title text-primary">Intentos Utilizados</h5>
                                <h3 class="text-primary" id="intentos-utilizados-display">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h5 class="card-title text-success">Intentos Permitidos</h5>
                                <h3 class="text-success" id="intentos-permitidos-display">-</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="nuevos-intentos" class="form-label">Nuevos Intentos Permitidos:</label>
                    <input type="number" class="form-control" id="nuevos-intentos" min="1" max="10" placeholder="Ej: 3">
                    <div class="form-text">Especifica el total de intentos que tendrá este participante.</div>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Nota:</strong> Al cambiar los intentos, el participante podrá realizar evaluaciones adicionales. La nota final será siempre la más alta obtenida.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btn-confirmar-intentos">
                    <i class="bi bi-check-circle"></i>
                    Actualizar Intentos
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let evaluacionId = {{ evaluacion.id }};
let monitoreoSocket = null;
let currentMonitoreoId = null;
let currentParticipanteId = null;
let reconnectInterval = null;
let connectionStatus = 'disconnected';
// Flag para habilitar logs de depuración WebSocket en consola (false en producción)
const DEBUG_WS = false;

// Función para formatear tiempo
function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}h ${minutes}m ${secs}s`;
    } else if (minutes > 0) {
        return `${minutes}m ${secs}s`;
    } else {
        return `${secs}s`;
    }
}

// Función para obtener el color del estado
function getEstadoColor(estaActivo, estado, finalizadoPorAdmin = false) {
    if (DEBUG_WS) console.log('getEstadoColor:', { estaActivo, estado, finalizadoPorAdmin });
    
    if (estado === 'finalizado') {
        return finalizadoPorAdmin ? 'danger' : 'secondary';
    }
    if (estado === 'suspendido') return 'danger';
    if (estado === 'activo') return 'success';
    return 'warning';
}

// Función para obtener el texto del estado
function getEstadoText(estaActivo, estado, finalizadoPorAdmin = false) {
    if (DEBUG_WS) console.log('getEstadoText:', { estaActivo, estado, finalizadoPorAdmin });
    
    if (estado === 'finalizado') {
        return finalizadoPorAdmin ? 'Finalizado por Admin' : 'Finalizado';
    }
    if (estado === 'suspendido') return 'Suspendido';
    if (estado === 'activo') return 'Activo';
    return 'Inactivo';
}

// Función para conectar WebSocket
function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const socketUrl = `${protocol}//${window.location.host}/ws/monitoreo/evaluacion/${evaluacionId}/`;
    
    monitoreoSocket = new WebSocket(socketUrl);
    
    monitoreoSocket.onopen = function(event) {
    if (DEBUG_WS) console.log('WebSocket conectado para monitoreo');
        connectionStatus = 'connected';
        updateConnectionStatus(true);
        
        // Limpiar intervalo de reconexión si existe
        if (reconnectInterval) {
            clearInterval(reconnectInterval);
            reconnectInterval = null;
        }
    };
    
    monitoreoSocket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    if (DEBUG_WS) console.log('WebSocket recibió mensaje:', data);
        
        switch (data.type) {
            case 'initial_data':
            case 'monitoring_update':
                if (DEBUG_WS) console.log('Manejando initial_data o monitoring_update');
                updateMonitoringTable(data.data);
                updateLastUpdate();
                break;
            case 'participant_update':
                if (DEBUG_WS) console.log('Manejando participant_update');
                handleParticipantUpdate(data);
                break;
            case 'intentos_updated':
                if (DEBUG_WS) console.log('Manejando intentos_updated');
                handleIntentosUpdated(data);
                break;
            case 'evaluacion_finalizada_admin':
                if (DEBUG_WS) console.log('Manejando evaluacion_finalizada_admin');
                handleEvaluacionFinalizadaAdmin(data);
                break;
            case 'request_update':
                if (DEBUG_WS) console.log('Manejando request_update, solicitando actualización manual');
                requestManualUpdate();
                break;
            case 'success':
                if (DEBUG_WS) console.log('Manejando success');
                // Usar toast global del sistema
                if (typeof showDynamicToast === 'function') {
                    showDynamicToast({
                        type: 'success',
                        title: 'Éxito',
                        message: data.message
                    });
                }
                break;
            case 'error':
                if (DEBUG_WS) console.log('Manejando error');
                // Usar toast global del sistema
                if (typeof showDynamicToast === 'function') {
                    showDynamicToast({
                        type: 'danger',
                        title: 'Error',
                        message: data.message
                    });
                }
                break;
            default:
                if (DEBUG_WS) console.log('Tipo de mensaje no manejado:', data.type);
                break;
        }
    };
    
    monitoreoSocket.onerror = function(error) {
    console.error('Error en WebSocket de monitoreo:', error);
        connectionStatus = 'error';
        updateConnectionStatus(false);
        
        // Usar toast global del sistema
        if (typeof showDynamicToast === 'function') {
            showDynamicToast({
                type: 'danger',
                title: 'Error de Conexión',
                message: 'Se perdió la conexión en tiempo real. Intentando reconectar...'
            });
        }
    };
    
    monitoreoSocket.onclose = function(event) {
    if (DEBUG_WS) console.log('WebSocket desconectado para monitoreo');
        connectionStatus = 'disconnected';
        updateConnectionStatus(false);
        
        // Limpiar intervalo de reconexión si existe
        if (reconnectInterval) {
            clearInterval(reconnectInterval);
            reconnectInterval = null;
        }
        
        // Programar reconexión automática
        if (!reconnectInterval) {
            reconnectInterval = setInterval(() => {
                if (connectionStatus === 'disconnected') {
                    if (DEBUG_WS) console.log('Intentando reconectar WebSocket...');
                    connectWebSocket();
                }
            }, 5000); // Intentar reconectar cada 5 segundos
        }
    };
}

// Función para actualizar el estado de conexión en la UI
function updateConnectionStatus(connected) {
    const statusElement = document.getElementById('last-update');
    
    if (connected) {
        statusElement.innerHTML = '<span class="text-success"><i class="bi bi-wifi"></i> Conectado en tiempo real</span>';
    } else {
        statusElement.innerHTML = '<span class="text-danger"><i class="bi-wifi-off"></i> Desconectado - Reconectando...</span>';
    }
}

// Función para actualizar la última actualización
function updateLastUpdate() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('es-EC');
    const dateString = now.toLocaleDateString('es-EC');
    
    const statusElement = document.getElementById('last-update');
    if (statusElement.innerHTML.includes('Conectado en tiempo real')) {
        statusElement.innerHTML = `<span class="text-success"><i class="bi bi-wifi"></i> Conectado en tiempo real</span><br><small class="text-muted">Última actualización: ${dateString} ${timeString}</small>`;
    }
}

// Función para actualizar estadísticas
function updateStatistics(stats) {
    // Actualizar tarjetas de estadísticas si existen elementos en el DOM
    const activosElement = document.querySelector('.card.bg-success .card-body h3');
    const pendientesElement = document.querySelector('.card.bg-warning .card-body h3');
    const finalizadosElement = document.querySelector('.card.bg-secondary .card-body h3');
    const totalElement = document.querySelector('.card.bg-info .card-body h3');
    
    if (activosElement) activosElement.textContent = stats.participantes_activos;
    if (pendientesElement) pendientesElement.textContent = stats.participantes_pendientes;
    if (finalizadosElement) finalizadosElement.textContent = stats.participantes_finalizados;
    if (totalElement) totalElement.textContent = stats.total_participantes;
}

// Función para actualizar la tabla de monitoreo
function updateMonitoringTable(data) {
    if (DEBUG_WS) console.log('updateMonitoringTable recibió:', data);
    
    if (!data) {
        if (DEBUG_WS) console.log('Data es null, solicitando actualización manual');
        requestManualUpdate();
        return;
    }
    
    if (data.error) {
        if (typeof showDynamicToast === 'function') {
            showDynamicToast({
                type: 'danger',
                title: 'Error',
                message: data.error
            });
        }
        return;
    }
    
    // Actualizar estadísticas
    if (data.estadisticas) {
        updateStatistics(data.estadisticas);
    }
    
    // Actualizar tabla
    if (data.monitoreos) {
        const tbody = document.getElementById('tbody-monitoreo');
        if (tbody) {
            tbody.innerHTML = '';
            
            data.monitoreos.forEach(monitoreo => {
                const row = createMonitoringRow(monitoreo);
                tbody.appendChild(row);
            });
        } else {
            console.error('Elemento tbody-monitoreo no encontrado');
        }
    }
    
    // Actualizar timestamp
    if (data.timestamp) {
        const lastUpdateElement = document.getElementById('last-update');
        if (lastUpdateElement) {
            const updateTime = new Date(data.timestamp).toLocaleTimeString();
            lastUpdateElement.innerHTML = 
                `<span class="text-success"><i class="bi bi-wifi"></i> ${updateTime}</span>`;
        }
    }
}

// Función para crear una fila de monitoreo
function createMonitoringRow(monitoreo) {
    const row = document.createElement('tr');
    
    // Determinar si fue finalizada por administrador
    const finalizadoPorAdmin = monitoreo.estado === 'finalizado' && monitoreo.finalizado_por_admin;
    
    // Determinar el contenido de la columna de progreso/puntaje
    let progresoPuntajeContent = '';
    
    if (monitoreo.estado === 'finalizado') {
        if (finalizadoPorAdmin) {
            // Evaluación finalizada por administrador - mostrar nota 0
            progresoPuntajeContent = `
                <div class="text-center">
                    <strong class="text-danger">0.000/10</strong><br>
                    <small class="text-muted">0.0%</small><br>
                    <span class="badge bg-danger">Finalizada por Admin</span>
                </div>
            `;
        } else if (monitoreo.tiene_resultado_completado) {
            // Evaluación completada normalmente - mostrar puntaje real
            const puntajeColor = monitoreo.puntaje >= 7 ? 'success' : 
                                monitoreo.puntaje >= 5 ? 'warning' : 'danger';
            progresoPuntajeContent = `
                <div class="text-center">
                    <strong class="text-${puntajeColor}">${monitoreo.puntaje_numerico}</strong><br>
                    <small class="text-muted">${monitoreo.puntaje.toFixed(1)}%</small>
                </div>
            `;
        } else {
            // Evaluación finalizada sin resultado - mostrar mensaje
            progresoPuntajeContent = `
                <div class="text-center">
                    <span class="badge bg-secondary">Sin resultado</span>
                </div>
            `;
        }
    } else if (monitoreo.estado === 'activo' && !monitoreo.tiene_resultado_completado) {
        // Mostrar progreso solo para evaluaciones activas que no están completadas
        if (DEBUG_WS) console.log('Datos de progreso:', {
            estado: monitoreo.estado,
            tiene_resultado: monitoreo.tiene_resultado_completado,
            porcentaje_avance: monitoreo.porcentaje_avance,
            preguntas_respondidas: monitoreo.preguntas_respondidas,
            preguntas_mostradas: monitoreo.preguntas_mostradas
        });
        
        // Calcular porcentaje basado en preguntas respondidas / preguntas a mostrar (configuradas)
        const preguntasRespondidas = monitoreo.preguntas_respondidas || 0;
        const preguntasAMostrar = {{ evaluacion.preguntas_a_mostrar }};
        const porcentaje = preguntasAMostrar > 0 ? Math.round((preguntasRespondidas / preguntasAMostrar) * 100) : 0;
        progresoPuntajeContent = `
            <div class="progress" style="height: 25px;">
                <div class="progress-bar bg-primary" role="progressbar" 
                     style="width: ${porcentaje}%" 
                     aria-valuenow="${porcentaje}" 
                     aria-valuemin="0" aria-valuemax="100">
                    ${porcentaje.toFixed(1)}%
                </div>
            </div>
            <small class="text-muted mt-1 d-block">
                ${preguntasRespondidas} respondidas de {{ evaluacion.preguntas_a_mostrar }}
            </small>
        `;
    } else if (monitoreo.estado === 'activo' && monitoreo.tiene_resultado_completado) {
        // Participante activo con resultado completado (puede tener nuevo intento)
        progresoPuntajeContent = `
            <div class="text-center">
                <span class="badge bg-info">Nuevo Intento Disponible</span><br>
                <small class="text-muted">Puede realizar evaluación adicional</small>
            </div>
        `;
    } else {
        // Para otros casos mostrar mensaje apropiado
        progresoPuntajeContent = `
            <div class="text-center">
                <span class="badge bg-secondary">No disponible</span>
            </div>
        `;
    }
    
    // Determinar el color y contenido de la columna de intentos
    if (DEBUG_WS) console.log('Datos de intentos:', {
        puede_realizar_intento: monitoreo.puede_realizar_intento,
        intentos_utilizados: monitoreo.intentos_utilizados,
        intentos_permitidos: monitoreo.intentos_permitidos,
        estado: monitoreo.estado,
        numero_intento_actual: monitoreo.numero_intento_actual
    });
    
    let intentosContent = '';
    let intentosColor, intentosText, intentosUtilizados;
    
    // Lógica de intentos: verde cuando tiene intentos disponibles, rojo cuando están agotados
    if (monitoreo.puede_realizar_intento) {
        // Tiene intentos disponibles - mostrar en verde
        intentosColor = 'success';
        intentosText = 'Disponibles';
        intentosUtilizados = monitoreo.intentos_utilizados;
    } else {
        // No puede realizar más intentos - mostrar en rojo
        intentosColor = 'danger';
        intentosText = 'Agotados';
        intentosUtilizados = monitoreo.intentos_permitidos; // Mostrar todos como utilizados
    }
    
    intentosContent = `
        <div class="text-center">
            <span class="badge bg-${intentosColor} fs-6">${intentosUtilizados}/${monitoreo.intentos_permitidos}</span><br>
            <small class="text-muted">${intentosText}</small>
            ${monitoreo.estado !== 'finalizado' ? `<br><small class="text-info">Intento ${monitoreo.numero_intento_actual}</small>` : ''}
        </div>
    `;

    // Agregar atributo data-participante-id para identificar la fila
    row.setAttribute('data-participante-id', monitoreo.participante_id);
    
    row.innerHTML = `
        <td>
            <strong>${monitoreo.participante_nombre}</strong><br>
            <small class="text-muted">${monitoreo.participante_cedula}</small>
        </td>
        <td class="estado-cell">
            <span class="badge bg-${getEstadoColor(monitoreo.esta_activo, monitoreo.estado, finalizadoPorAdmin)}">
                ${getEstadoText(monitoreo.esta_activo, monitoreo.estado, finalizadoPorAdmin)}
            </span>
        </td>
        <td>${intentosContent}</td>
        <td class="progreso-cell">${progresoPuntajeContent}</td>
        <td>
            ${monitoreo.alertas_count > 0 ? 
                `<span class="badge bg-danger">${monitoreo.alertas_count}</span>` : 
                '<span class="badge bg-success">0</span>'
            }
        </td>
        <td>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-info" 
                        onclick="verDetalles(${monitoreo.id})" 
                        title="Ver detalles">
                    <i class="bi bi-eye"></i>
                </button>
                <button type="button" class="btn btn-outline-primary" 
                        onclick="gestionarIntentos(${monitoreo.participante_id}, '${monitoreo.participante_nombre}', '${monitoreo.participante_cedula}', ${monitoreo.intentos_utilizados}, ${monitoreo.intentos_permitidos})" 
                        title="Gestionar intentos">
                    <i class="bi bi-arrow-repeat"></i>
                </button>
                ${monitoreo.estado !== 'finalizado' ? `
                    <button type="button" class="btn btn-outline-warning" 
                            onclick="agregarAlerta(${monitoreo.id})" 
                            title="Agregar alerta">
                        <i class="bi bi-exclamation-triangle"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger" 
                             onclick="finalizarEvaluacion(${monitoreo.id}, '${monitoreo.participante_nombre}')" 
                             title="Finalizar evaluación">
                        <i class="bi bi-stop-circle"></i>
                    </button>
                ` : ''}
            </div>
        </td>
    `;
    
    return row;
}

// Funciones auxiliares para eliminar duplicación
function findParticipantRow(participantId) {
    return document.querySelector(`tr[data-participante-id="${participantId}"]`);
}

function updateRowAndHighlight(row, success = true) {
    if (row) {
        // Destacar la fila temporalmente para mostrar que se actualizó
        highlightRow(row);
        return true;
    } else {
        // Si no se encuentra la fila, solicitar actualización completa
        if (monitoreoSocket && monitoreoSocket.readyState === WebSocket.OPEN) {
            monitoreoSocket.send(JSON.stringify({
                type: 'request_update'
            }));
        }
        return false;
    }
}

// Función para solicitar actualización manual del estado
function requestManualUpdate() {
    if (DEBUG_WS) console.log('Solicitando actualización manual del estado...');
    
    // Enviar mensaje al WebSocket para solicitar actualización
    if (monitoreoSocket && monitoreoSocket.readyState === WebSocket.OPEN) {
        monitoreoSocket.send(JSON.stringify({
            type: 'request_update',
            evaluacion_id: evaluacionId,
            timestamp: new Date().toISOString()
        }));
    } else {
        // Si el WebSocket no está disponible, hacer petición HTTP
        fetch(`/quizzes/evaluacion/${evaluacionId}/estado-monitoreo/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (DEBUG_WS) console.log('Actualización manual recibida:', data);
            updateMonitoringTable(data);
        })
        .catch(error => {
            console.error('Error en actualización manual:', error);
            if (typeof showDynamicToast === 'function') {
                showDynamicToast({
                    type: 'warning',
                    title: 'Advertencia',
                    message: 'No se pudo actualizar el estado. Revisa la conexión.'
                });
            }
        });
    }
}

// Función para obtener cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Función para manejar actualizaciones de participantes individuales
function handleParticipantUpdate(data) {
    if (DEBUG_WS) console.log('handleParticipantUpdate recibió:', data);
    
    // Normalizar participant_id a participante_id para compatibilidad
    if (data.participant_id && !data.participante_id) {
        data.participante_id = data.participant_id;
    }
    
    if (!data || !data.participante_id) {
        console.error('Datos incompletos en handleParticipantUpdate');
        return;
    }
    
    const row = document.querySelector(`tr[data-participante-id="${data.participante_id}"]`);
    if (!row) {
        if (DEBUG_WS) console.log(`Fila para participante ${data.participante_id} no encontrada, solicitando actualización completa`);
        requestManualUpdate();
        return;
    }
    
    // Actualizar estado
    if (data.estado !== undefined) {
        const estadoCell = row.querySelector('.estado-cell');
        if (estadoCell) {
            const estaActivo = data.esta_activo !== undefined ? data.esta_activo : false;
            const finalizadoPorAdmin = data.finalizado_por_admin !== undefined ? data.finalizado_por_admin : false;
            estadoCell.innerHTML = `
                <span class="badge bg-${getEstadoColor(estaActivo, data.estado, finalizadoPorAdmin)}">
                    ${getEstadoText(estaActivo, data.estado, finalizadoPorAdmin)}
                </span>
            `;
            
            // Si fue finalizada por admin, actualizar también los intentos
            if (finalizadoPorAdmin && data.estado === 'finalizado') {
                const intentosCell = row.querySelector('td:nth-child(3)');
                if (intentosCell) {
                    const intentosPermitidos = data.intentos_permitidos || 1;
                    intentosCell.innerHTML = `
                        <div class="text-center">
                            <span class="badge bg-danger fs-6">${intentosPermitidos}/${intentosPermitidos}</span><br>
                            <small class="text-muted">Agotados</small>
                        </div>
                    `;
                }
            }
        }
    }
    
    // Actualizar progreso
    if (data.data && (data.data.answered_questions !== undefined || data.data.reviewed_questions !== undefined)) {
        const progresoCell = row.querySelector('.progreso-cell');
        if (progresoCell) {
            // Usar los datos del objeto data.data
            const answeredQuestions = data.data.answered_questions || 0;
            const preguntasAMostrar = {{ evaluacion.preguntas_a_mostrar }};
            const porcentaje = preguntasAMostrar > 0 ? Math.round((answeredQuestions / preguntasAMostrar) * 100) : 0;
            
            // Solo mostrar progreso si el estado es activo y no está completado
            const estadoCell = row.querySelector('.estado-cell');
            const estaActivo = estadoCell && estadoCell.textContent.includes('Activo');
            const estaFinalizado = estadoCell && (estadoCell.textContent.includes('Finalizado') || estadoCell.textContent.includes('Admin'));
            
            if (estaActivo && !estaFinalizado) {
                const progresoPuntajeContent = `
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-primary" role="progressbar" 
                             style="width: ${porcentaje}%" 
                             aria-valuenow="${porcentaje}" 
                             aria-valuemin="0" aria-valuemax="100">
                            ${porcentaje}%
                        </div>
                    </div>
                    <small class="text-muted mt-1 d-block">
                        ${answeredQuestions} respondidas
                    </small>
                `;
                progresoCell.innerHTML = progresoPuntajeContent;
                
                // Destacar la fila para mostrar el cambio
                highlightRow(row);
            }
        }
    }
    
    // Actualizar progreso con datos normalizados (si vienen directamente)
    if (data.porcentaje_avance !== undefined || data.estado !== undefined || data.tiene_resultado_completado !== undefined) {
        const progresoCell = row.querySelector('.progreso-cell');
        if (progresoCell) {
            if (DEBUG_WS) console.log('Actualizando progreso con datos normalizados:', data);
            
            // Verificar si la evaluación está finalizada
            const estadoCell = row.querySelector('.estado-cell');
            const estaFinalizada = estadoCell && (estadoCell.textContent.includes('Finalizado') || estadoCell.textContent.includes('Admin'));
            
            let progresoPuntajeContent = '';
            
            if (data.estado === 'finalizado' || estaFinalizada) {
                if (data.finalizado_por_admin || (estadoCell && estadoCell.textContent.includes('Admin'))) {
                    // Evaluación finalizada por administrador - mostrar nota 0
                    progresoPuntajeContent = `
                        <div class="text-center">
                            <strong class="text-danger">0.000/10</strong><br>
                            <small class="text-muted">0.0%</small><br>
                            <span class="badge bg-danger">Finalizada por Admin</span>
                        </div>
                    `;
                } else if (data.tiene_resultado_completado) {
                    // Evaluación completada normalmente - mostrar puntaje real
                    const puntajeColor = data.puntaje >= 7 ? 'success' : 
                                        data.puntaje >= 5 ? 'warning' : 'danger';
                    progresoPuntajeContent = `
                        <div class="text-center">
                            <strong class="text-${puntajeColor}">${data.puntaje_numerico}</strong><br>
                            <small class="text-muted">${data.puntaje.toFixed(1)}%</small>
                        </div>
                    `;
                } else {
                    // Evaluación finalizada sin resultado - mostrar mensaje
                    progresoPuntajeContent = `
                        <div class="text-center">
                            <span class="badge bg-secondary">Sin resultado</span>
                        </div>
                    `;
                }
            } else if (data.estado === 'activo' && !data.tiene_resultado_completado) {
                // Mostrar progreso solo para evaluaciones activas que no están completadas
                // Calcular porcentaje basado en preguntas respondidas / preguntas a mostrar (configuradas)
                const preguntasRespondidas = data.preguntas_respondidas || 0;
                const preguntasAMostrar = {{ evaluacion.preguntas_a_mostrar }};
                const porcentaje = preguntasAMostrar > 0 ? Math.round((preguntasRespondidas / preguntasAMostrar) * 100) : 0;
                progresoPuntajeContent = `
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-primary" role="progressbar" 
                             style="width: ${porcentaje}%" 
                             aria-valuenow="${porcentaje}" 
                             aria-valuemin="0" aria-valuemax="100">
                            ${porcentaje.toFixed(1)}%
                        </div>
                    </div>
                    <small class="text-muted mt-1 d-block">
                        ${preguntasRespondidas} respondidas de {{ evaluacion.preguntas_a_mostrar }}
                    </small>
                `;
            } else if (data.estado === 'activo' && data.tiene_resultado_completado) {
                // Participante activo con resultado completado (puede tener nuevo intento)
                progresoPuntajeContent = `
                    <div class="text-center">
                        <span class="badge bg-info">Nuevo Intento Disponible</span><br>
                        <small class="text-muted">Puede realizar evaluación adicional</small>
                    </div>
                `;
            } else {
                // Para otros casos mostrar mensaje apropiado
                progresoPuntajeContent = `
                    <div class="text-center">
                        <span class="badge bg-secondary">No disponible</span>
                    </div>
                `;
            }
            
            progresoCell.innerHTML = progresoPuntajeContent;
            
            // Destacar la fila para mostrar el cambio
            highlightRow(row);
        }
    }
    
    // Actualizar timestamp
    updateLastUpdate();
}

// Función para manejar actualización de intentos
function handleIntentosUpdated(data) {
    if (DEBUG_WS) console.log('handleIntentosUpdated recibió:', data);
    
    if (!data || !data.participante_id) {
        console.error('Datos incompletos en handleIntentosUpdated');
        return;
    }
    
    // Buscar la fila del participante
    const row = document.querySelector(`tr[data-participante-id="${data.participante_id}"]`);
    if (!row) {
        if (DEBUG_WS) console.log(`Fila para participante ${data.participante_id} no encontrada`);
        return;
    }
    
    // Actualizar la columna de intentos
    const intentosCell = row.querySelector('td:nth-child(3)');
    if (intentosCell) {
        let intentosColor, intentosText, intentosUtilizados;
        
        // Aplicar la misma lógica que en createMonitoringRow
        if (data.puede_realizar_intento) {
            // Tiene intentos disponibles - mostrar en verde
            intentosColor = 'success';
            intentosText = 'Disponibles';
            intentosUtilizados = data.intentos_utilizados;
        } else {
            // No puede realizar más intentos - mostrar en rojo
            intentosColor = 'danger';
            intentosText = 'Agotados';
            intentosUtilizados = data.intentos_permitidos; // Mostrar todos como utilizados
        }
        
        intentosCell.innerHTML = `
            <div class="text-center">
                <span class="badge bg-${intentosColor} fs-6">${intentosUtilizados}/${data.intentos_permitidos}</span><br>
                <small class="text-muted">${intentosText}</small>
                ${data.estado !== 'finalizado' ? `<br><small class="text-info">Intento ${data.numero_intento_actual}</small>` : ''}
            </div>
        `;
    }
    
    // Si el participante ahora puede realizar un nuevo intento, actualizar el estado
    if (data.puede_realizar_intento && data.estado === 'finalizado') {
        // Solicitar actualización completa del estado
        setTimeout(() => {
            requestManualUpdate();
        }, 500);
    }
    
    // Mostrar notificación
    if (typeof showDynamicToast === 'function') {
        showDynamicToast({
            type: 'success',
            title: 'Intentos Actualizados',
            message: 'Los intentos del participante han sido actualizados correctamente.'
        });
    }
}

// Función para manejar finalización administrativa
function handleEvaluacionFinalizadaAdmin(data) {
    if (DEBUG_WS) console.log('handleEvaluacionFinalizadaAdmin recibió:', data);
    
    if (!data || !data.participante_id) {
        console.error('Datos incompletos en handleEvaluacionFinalizadaAdmin');
        return;
    }
    
    // Buscar la fila del participante
    const row = document.querySelector(`tr[data-participante-id="${data.participante_id}"]`);
    if (!row) {
        if (DEBUG_WS) console.log(`Fila para participante ${data.participante_id} no encontrada`);
        // Solicitar actualización completa si no se encuentra la fila
        setTimeout(() => {
            requestManualUpdate();
        }, 500);
        return;
    }
    
    // Actualizar estado a "Finalizado por Admin"
    const estadoCell = row.querySelector('.estado-cell');
    if (estadoCell) {
        estadoCell.innerHTML = `
            <span class="badge bg-danger">
                Finalizado por Admin
            </span>
        `;
    }
    
    // Actualizar progreso a "Finalizada por Admin" con nota 0
    const progresoCell = row.querySelector('.progreso-cell');
    if (progresoCell) {
        progresoCell.innerHTML = `
            <div class="text-center">
                <strong class="text-danger">0.000/10</strong><br>
                <small class="text-muted">0.0%</small><br>
                <span class="badge bg-danger">Finalizada por Admin</span>
            </div>
        `;
    }
    
    // Actualizar intentos para mostrar que están agotados (en rojo)
    const intentosCell = row.querySelector('td:nth-child(3)');
    if (intentosCell) {
        const intentosUtilizados = data.intentos_utilizados || 1;
        const intentosPermitidos = data.intentos_permitidos || 1;
        intentosCell.innerHTML = `
            <div class="text-center">
                <span class="badge bg-danger fs-6">${intentosUtilizados}/${intentosPermitidos}</span><br>
                <small class="text-muted">Agotados</small>
            </div>
        `;
    }
    
    // Actualizar botones de acciones (quitar botones de finalizar y agregar alerta)
    const accionesCell = row.querySelector('td:last-child');
    if (accionesCell) {
        const monitoreoId = data.monitoreo_id || 0;
        const participanteId = data.participante_id;
        const participanteNombre = data.participante_nombre || 'Participante';
        const participanteCedula = data.participante_cedula || '';
        const intentosUtilizados = data.intentos_utilizados || 1;
        const intentosPermitidos = data.intentos_permitidos || 1;
        
        accionesCell.innerHTML = `
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-info" 
                        onclick="verDetalles(${monitoreoId})" 
                        title="Ver detalles">
                    <i class="bi bi-eye"></i>
                </button>
                <button type="button" class="btn btn-outline-primary" 
                        onclick="gestionarIntentos(${participanteId}, '${participanteNombre}', '${participanteCedula}', ${intentosUtilizados}, ${intentosPermitidos})" 
                        title="Gestionar intentos">
                    <i class="bi bi-arrow-repeat"></i>
                </button>
            </div>
        `;
    }
    
    // Destacar la fila para mostrar el cambio
    highlightRow(row);
    
    // Mostrar notificación
    if (typeof showDynamicToast === 'function') {
        showDynamicToast({
            type: 'warning',
            title: 'Evaluación Finalizada',
            message: `La evaluación de ${data.participante_nombre || 'el participante'} ha sido finalizada administrativamente.`
        });
    }
    
    // Solicitar actualización completa después de un momento para sincronizar
    setTimeout(() => {
        requestManualUpdate();
    }, 2000);
}

// Función para destacar una fila temporalmente
function highlightRow(row) {
    row.classList.add('table-warning');
    setTimeout(() => {
        row.classList.remove('table-warning');
    }, 2000);
}

// Función para actualizar una fila específica de participante
function updateParticipantRow(row, data) {
    try {
        // Solo actualizar campos que realmente cambiaron para evitar parpadeos
        
        // Actualizar progreso solo si es necesario
        if (data.porcentaje_avance !== undefined || data.estado !== undefined || data.tiene_resultado_completado !== undefined) {
            const progresoCell = row.querySelector('.progreso-cell');
            if (progresoCell) {
                if (DEBUG_WS) console.log('Actualizando progreso con datos:', data);
                
                // Verificar si la evaluación está finalizada
                const estadoCell = row.querySelector('.estado-cell');
                const estaFinalizada = estadoCell && estadoCell.textContent.includes('Finalizado');
                const finalizadoPorAdmin = estadoCell && estadoCell.textContent.includes('por Admin');
                
                let progresoPuntajeContent = '';
                
                if (data.estado === 'finalizado') {
                    if (finalizadoPorAdmin) {
                        // Evaluación finalizada por administrador - mostrar nota 0
                        progresoPuntajeContent = `
                            <div class="text-center">
                                <strong class="text-danger">0.000/10</strong><br>
                                <small class="text-muted">0.0%</small><br>
                                <span class="badge bg-danger">Finalizada por Admin</span>
                            </div>
                        `;
                    } else if (data.tiene_resultado_completado) {
                        // Evaluación completada normalmente - mostrar puntaje real
                        const puntajeColor = data.puntaje >= 7 ? 'success' : 
                                            data.puntaje >= 5 ? 'warning' : 'danger';
                        progresoPuntajeContent = `
                            <div class="text-center">
                                <strong class="text-${puntajeColor}">${data.puntaje_numerico}</strong><br>
                                <small class="text-muted">${data.puntaje.toFixed(1)}%</small>
                            </div>
                        `;
                    } else {
                        // Evaluación finalizada sin resultado - mostrar mensaje
                        progresoPuntajeContent = `
                            <div class="text-center">
                                <span class="badge bg-secondary">Sin resultado</span>
                            </div>
                        `;
                    }
                } else if (data.estado === 'activo' && !data.tiene_resultado_completado) {
                    // Mostrar progreso solo para evaluaciones activas que no están completadas
                    if (DEBUG_WS) console.log('Mostrando progreso para evaluación activa:', {
                        porcentaje_avance: data.porcentaje_avance,
                        preguntas_respondidas: data.preguntas_respondidas,
                        preguntas_mostradas: data.preguntas_mostradas
                    });
                    
                    // Calcular porcentaje basado en preguntas respondidas / preguntas a mostrar (configuradas)
                    const preguntasRespondidas = data.preguntas_respondidas || 0;
                    const preguntasAMostrar = {{ evaluacion.preguntas_a_mostrar }};
                    const porcentaje = preguntasAMostrar > 0 ? Math.round((preguntasRespondidas / preguntasAMostrar) * 100) : 0;
                    progresoPuntajeContent = `
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-primary" role="progressbar" 
                                 style="width: ${porcentaje}%" 
                                 aria-valuenow="${porcentaje}" 
                                 aria-valuemin="0" aria-valuemax="100">
                                ${porcentaje.toFixed(1)}%
                            </div>
                        </div>
                        <small class="text-muted mt-1 d-block">
                            ${preguntasRespondidas} respondidas de {{ evaluacion.preguntas_a_mostrar }}
                        </small>
                    `;
                } else if (data.estado === 'activo' && data.tiene_resultado_completado) {
                    // Participante activo con resultado completado (puede tener nuevo intento)
                    progresoPuntajeContent = `
                        <div class="text-center">
                            <span class="badge bg-info">Nuevo Intento Disponible</span><br>
                            <small class="text-muted">Puede realizar evaluación adicional</small>
                        </div>
                    `;
                } else {
                    // Para otros casos mostrar mensaje apropiado
                    progresoPuntajeContent = `
                        <div class="text-center">
                            <span class="badge bg-secondary">No disponible</span>
                        </div>
                    `;
                }
                
                progresoCell.innerHTML = progresoPuntajeContent;
            }
        }
        
        // Actualizar estado si es necesario
        if (data.estado !== undefined) {
            const estadoCell = row.querySelector('.estado-cell');
            if (estadoCell) {
                const estaActivo = data.esta_activo !== undefined ? data.esta_activo : false;
                const finalizadoPorAdmin = data.finalizado_por_admin !== undefined ? data.finalizado_por_admin : false;
                estadoCell.innerHTML = `
                    <span class="badge bg-${getEstadoColor(estaActivo, data.estado, finalizadoPorAdmin)}">
                        ${getEstadoText(estaActivo, data.estado, finalizadoPorAdmin)}
                    </span>
                `;
            }
        }
        
        // Actualizar alertas si es necesario
        if (data.alertas_count !== undefined) {
            const alertasCell = row.querySelector('td:nth-child(5)');
            if (alertasCell) {
                alertasCell.innerHTML = data.alertas_count > 0 ? 
                    `<span class="badge bg-danger">${data.alertas_count}</span>` : 
                    '<span class="badge bg-success">0</span>';
            }
        }
        
        // Si es un nuevo intento, actualizar también la información de intentos
        if (data.event_type === 'new_attempt') {
            const intentosCell = row.querySelector('td:nth-child(3)');
            if (intentosCell) {
                intentosCell.innerHTML = `
                    <div class="text-center">
                        <span class="badge bg-success fs-6">0/${data.intentos_permitidos || 1}</span><br>
                        <small class="text-muted">Disponibles</small>
                        <br><small class="text-info">Intento 1</small>
                    </div>
                `;
            }
        }
        
    } catch (error) {
        console.error('Error al actualizar fila del participante:', error);
    }
}

// Función para finalizar evaluación
function finalizarEvaluacion(monitoreoId, participanteNombre) {
    currentMonitoreoId = monitoreoId;
    document.getElementById('participante-nombre').textContent = participanteNombre;
    document.getElementById('motivo-finalizacion').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('modalFinalizar'));
    modal.show();
}

// Función para agregar alerta
function agregarAlerta(monitoreoId) {
    currentMonitoreoId = monitoreoId;
    document.getElementById('tipo-alerta').value = 'comportamiento';
    document.getElementById('severidad-alerta').value = 'media';
    document.getElementById('descripcion-alerta').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('modalAlerta'));
    modal.show();
}

// Función para ver detalles
function verDetalles(monitoreoId) {
    window.location.href = `/monitoreo/${monitoreoId}/detalle/`;
}

// Función para gestionar intentos
function gestionarIntentos(participanteId, participanteNombre, participanteCedula, intentosUtilizados, intentosPermitidos) {
    currentParticipanteId = participanteId;
    
    // Actualizar información en el modal
    document.getElementById('intentos-participante-nombre').textContent = participanteNombre;
    document.getElementById('intentos-participante-cedula').textContent = participanteCedula;
    document.getElementById('intentos-utilizados-display').textContent = intentosUtilizados;
    document.getElementById('intentos-permitidos-display').textContent = intentosPermitidos;
    document.getElementById('nuevos-intentos').value = intentosPermitidos;
    
    const modal = new bootstrap.Modal(document.getElementById('modalIntentos'));
    modal.show();
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Conectar WebSocket
    connectWebSocket();
    
    // Confirmar finalización via WebSocket
    document.getElementById('btn-confirmar-finalizar').addEventListener('click', function() {
        const motivo = document.getElementById('motivo-finalizacion').value;
        if (!motivo.trim()) {
            if (typeof showDynamicToast === 'function') {
                showDynamicToast({
                    type: 'warning',
                    title: 'Advertencia',
                    message: 'Por favor, ingrese un motivo para la finalización.'
                });
            }
            return;
        }
        
        if (monitoreoSocket && monitoreoSocket.readyState === WebSocket.OPEN) {
            monitoreoSocket.send(JSON.stringify({
                type: 'finalizar_evaluacion',
                monitoreo_id: currentMonitoreoId,
                motivo: motivo
            }));
            bootstrap.Modal.getInstance(document.getElementById('modalFinalizar')).hide();
        } else {
            if (typeof showDynamicToast === 'function') {
                showDynamicToast({
                    type: 'danger',
                    title: 'Error',
                    message: 'No hay conexión WebSocket disponible'
                });
            }
        }
    });
    
    // Confirmar alerta via WebSocket
    document.getElementById('btn-confirmar-alerta').addEventListener('click', function() {
        const tipoAlerta = document.getElementById('tipo-alerta').value;
        const severidad = document.getElementById('severidad-alerta').value;
        const descripcion = document.getElementById('descripcion-alerta').value;
        
        if (!descripcion.trim()) {
            if (typeof showDynamicToast === 'function') {
                showDynamicToast({
                    type: 'warning',
                    title: 'Advertencia',
                    message: 'Por favor, ingrese una descripción para la alerta.'
                });
            }
            return;
        }
        
        if (monitoreoSocket && monitoreoSocket.readyState === WebSocket.OPEN) {
            monitoreoSocket.send(JSON.stringify({
                type: 'agregar_alerta',
                monitoreo_id: currentMonitoreoId,
                tipo_alerta: tipoAlerta,
                severidad: severidad,
                descripcion: descripcion
            }));
            bootstrap.Modal.getInstance(document.getElementById('modalAlerta')).hide();
        } else {
            if (typeof showDynamicToast === 'function') {
                showDynamicToast({
                    type: 'danger',
                    title: 'Error',
                    message: 'No hay conexión WebSocket disponible'
                });
            }
        }
    });
    
    // Confirmar actualización de intentos
    document.getElementById('btn-confirmar-intentos').addEventListener('click', function() {
        const nuevosIntentos = parseInt(document.getElementById('nuevos-intentos').value);
        
        if (DEBUG_WS) console.log('Intentando actualizar intentos:', {
            participante_id: currentParticipanteId,
            evaluacion_id: evaluacionId,
            nuevos_intentos: nuevosIntentos
        });
        
        if (isNaN(nuevosIntentos) || nuevosIntentos < 1) {
            if (typeof showDynamicToast === 'function') {
                showDynamicToast({
                    type: 'warning',
                    title: 'Advertencia',
                    message: 'Por favor, ingrese un número válido de intentos.'
                });
            }
            return;
        }
        
        // Enviar actualización via WebSocket
        if (monitoreoSocket && monitoreoSocket.readyState === WebSocket.OPEN) {
            const messageData = {
                type: 'update_intentos',
                participante_id: currentParticipanteId,
                evaluacion_id: evaluacionId,
                nuevos_intentos: nuevosIntentos,
                timestamp: new Date().toISOString()
            };
            
            if (DEBUG_WS) console.log('Enviando mensaje WebSocket:', messageData);
            monitoreoSocket.send(JSON.stringify(messageData));
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalIntentos'));
            modal.hide();
            
            // Solicitar actualización del estado
            setTimeout(() => {
                if (DEBUG_WS) console.log('Solicitando actualización manual después de cambio de intentos');
                requestManualUpdate();
            }, 1000);
        } else {
            console.error('WebSocket no está conectado');
            if (typeof showDynamicToast === 'function') {
                showDynamicToast({
                    type: 'danger',
                    title: 'Error',
                    message: 'No se pudo conectar para actualizar los intentos.'
                });
            }
        }
    });
    
    // Limpiar conexión WebSocket al cerrar la página
    window.addEventListener('beforeunload', function() {
        if (monitoreoSocket) {
            monitoreoSocket.close();
        }
    });
});

</script>
{% endblock %} 