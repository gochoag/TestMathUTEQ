{% extends 'base.html' %}
{% block sidebar %}
    {% include 'quizzes/sidebar.html' %}
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <!-- Header del monitoreo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-0">
                                <i class="bi bi-eye-fill"></i>
                                Monitoreo en Tiempo Real
                            </h2>
                            <p class="mb-0 mt-2">
                                <strong>{{ evaluacion.title }}</strong> - {{ evaluacion.get_etapa_display }}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex justify-content-end align-items-center">
                                <div class="me-3">
                                    <small>Última actualización:</small><br>
                                    <span id="last-update" class="monitoreo-tiempo-real">Cargando...</span>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                                    <label class="form-check-label" for="auto-refresh">
                                        Auto-refresh (5s)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas generales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ participantes_activos }}</h3>
                    <p class="mb-0">Activos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ participantes_pendientes }}</h3>
                    <p class="mb-0">Pendientes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ participantes_finalizados }}</h3>
                    <p class="mb-0">Finalizados</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ total_participantes }}</h3>
                    <p class="mb-0">Total</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de monitoreo -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-people-fill"></i>
                        Participantes en Evaluación
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tabla-monitoreo">
                            <thead class="table-dark">
                                <tr>
                                    <th>Participante</th>
                                    <th>Estado</th>
                                    <th>Progreso/Puntaje</th>
                                    <th>Última Actividad</th>
                                    <th>Intentos</th>
                                    <th>Cambios Pestañas</th>
                                    <th>Alertas</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-monitoreo">
                                <!-- Los datos se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para finalizar evaluación -->
<div class="modal fade" id="modalFinalizar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i>
                    Finalizar Evaluación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>¿Estás seguro de que deseas finalizar la evaluación de <span id="participante-nombre"></span>?</strong></p>
                <p class="text-muted">Esta acción no se puede deshacer.</p>
                <div class="mb-3">
                    <label for="motivo-finalizacion" class="form-label">Motivo de la finalización:</label>
                    <textarea class="form-control" id="motivo-finalizacion" rows="3" placeholder="Describa el motivo de la finalización..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btn-confirmar-finalizar">
                    <i class="bi bi-stop-circle"></i>
                    Finalizar Evaluación
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar alerta -->
<div class="modal fade" id="modalAlerta" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i>
                    Agregar Alerta
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="tipo-alerta" class="form-label">Tipo de Alerta:</label>
                    <select class="form-select" id="tipo-alerta">
                        <option value="comportamiento">Comportamiento Sospechoso</option>
                        <option value="tecnico">Problema Técnico</option>
                        <option value="conexion">Problema de Conexión</option>
                        <option value="inactividad">Inactividad Prolongada</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="severidad-alerta" class="form-label">Severidad:</label>
                    <select class="form-select" id="severidad-alerta">
                        <option value="baja">Baja</option>
                        <option value="media">Media</option>
                        <option value="alta">Alta</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="descripcion-alerta" class="form-label">Descripción:</label>
                    <textarea class="form-control" id="descripcion-alerta" rows="3" placeholder="Describa la alerta..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btn-confirmar-alerta">
                    <i class="bi bi-plus-circle"></i>
                    Agregar Alerta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para dar nuevo intento -->
<div class="modal fade" id="modalNuevoIntento" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-clockwise"></i>
                    Otorgar Nuevo Intento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info alert-sm">
                    <i class="bi bi-info-circle"></i>
                    <strong>Participante:</strong> <span id="nombre-participante-intento"></span>
                </div>
                
                <!-- Información compacta de intentos -->
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="text-center p-2 border rounded bg-light">
                            <small class="text-muted d-block">Gastados</small>
                            <h4 class="mb-0 text-danger" id="intentos-usados">0</h4>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-2 border rounded bg-light">
                            <small class="text-muted d-block">Total Actual</small>
                            <h4 class="mb-0 text-info" id="intentos-totales">1</h4>
                        </div>
                    </div>
                </div>
                
                <!-- Input compacto para nuevos intentos -->
                <div class="row align-items-end">
                    <div class="col-8">
                        <label for="cantidad-intentos" class="form-label small mb-1">
                            <i class="bi bi-plus-circle text-success"></i> Intentos adicionales:
                        </label>
                        <select class="form-select" id="cantidad-intentos">
                            <option value="1" selected>1 intento adicional</option>
                            <option value="2">2 intentos adicionales</option>
                            <option value="3">3 intentos adicionales</option>
                            <option value="5">5 intentos adicionales</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <div class="text-center">
                            <small class="text-muted d-block mb-1">Nuevo Total</small>
                            <span class="badge bg-success fs-6" id="nuevo-total">2</span>
                        </div>
                    </div>
                </div>
                
                <small class="text-muted mt-2 d-block">
                    <i class="bi bi-exclamation-circle"></i>
                    Se aumentará el límite de intentos. Esta acción no se puede deshacer.
                </small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btn-confirmar-nuevo-intento">
                    <i class="bi bi-check-circle"></i>
                    Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para reducir cambios de pestañas -->
<div class="modal fade" id="modalReducirCambiosPestana" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-dash-circle"></i>
                    Reducir Cambios de Pestañas
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info alert-sm">
                    <i class="bi bi-info-circle"></i>
                    <strong>Participante:</strong> <span id="nombre-participante-reducir"></span>
                </div>
                
                <!-- Información compacta de cambios de pestañas -->
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="text-center p-2 border rounded bg-light">
                            <small class="text-muted d-block">Cambios Actuales</small>
                            <h4 class="mb-0 text-danger" id="cambios-actuales">0</h4>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-2 border rounded bg-light">
                            <small class="text-muted d-block">Máximo Permitido</small>
                            <h4 class="mb-0 text-warning" id="cambios-maximo">3</h4>
                        </div>
                    </div>
                </div>
                
                <!-- Input compacto para cantidad a reducir -->
                <div class="row align-items-end">
                    <div class="col-8">
                        <label for="cantidad-reducir" class="form-label small mb-1">
                            <i class="bi bi-dash-circle text-danger"></i> Cantidad a reducir:
                        </label>
                        <select class="form-select" id="cantidad-reducir">
                            <option value="1" selected>1 cambio</option>
                            <option value="2">2 cambios</option>
                            <option value="3">3 cambios</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <div class="text-center">
                            <small class="text-muted d-block mb-1">Nuevo Total</small>
                            <span class="badge bg-success fs-6" id="nuevo-total-cambios">0</span>
                        </div>
                    </div>
                </div>
                
                <small class="text-muted mt-2 d-block">
                    <i class="bi bi-exclamation-circle"></i>
                    Esta acción reducirá el contador de cambios de pestañas del participante.
                </small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btn-confirmar-reducir">
                    <i class="bi bi-check-circle"></i>
                    Confirmar Reducción
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles -->
<div class="modal fade" id="modalDetalles" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i>
                    Detalles del Monitoreo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detalles-contenido">
                <!-- Los detalles se cargarán dinámicamente -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
/* Estilo para las transiciones del monitoreo en tiempo real */
#tabla-monitoreo tbody tr {
    transition: background-color 0.3s ease-in-out;
}

/* Efecto de pulso para cambios importantes */
@keyframes pulso {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

.fila-actualizada {
    animation: pulso 0.6s ease-in-out;
}

/* Indicador de tiempo real activo */
.monitoreo-tiempo-real::after {
    content: " 🔴";
    animation: parpadeo 1s infinite;
}

@keyframes parpadeo {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

/* Estilos para el modal de intentos compacto */
.alert-sm {
    padding: 0.5rem 0.75rem;
    margin-bottom: 1rem;
}

#modalNuevoIntento .modal-body {
    padding: 1rem 1.5rem;
}

#modalNuevoIntento .border {
    border-width: 2px !important;
}

#nuevo-total {
    font-size: 1.2rem !important;
    padding: 0.5rem 1rem !important;
    transition: transform 0.2s ease, background-color 0.3s ease;
}

#nuevo-total:hover {
    background-color: #198754 !important;
}

/* Estilos para el modal de reducir cambios de pestañas */
#nuevo-total-cambios {
    font-size: 1.2rem !important;
    padding: 0.5rem 1rem !important;
    transition: transform 0.2s ease, background-color 0.3s ease;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales para el monitoreo en tiempo real
let evaluacionId = {{ evaluacion.id }};
let autoRefreshInterval;
let currentMonitoreoId = null;
let lastMonitoreoData = {}; // Cache para detectar cambios

// Función para formatear tiempo
function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}h ${minutes}m ${secs}s`;
    } else if (minutes > 0) {
        return `${minutes}m ${secs}s`;
    } else {
        return `${secs}s`;
    }
}

// Función para obtener el color del estado
function getEstadoColor(estaActivo, estado, haIniciado, intentosDisponibles) {
    // Priorizar el estado explícito de la base de datos
    if (estado === 'finalizado' && intentosDisponibles === 0) return 'secondary'; // Finalizado definitivo
    if (estado === 'suspendido') return 'danger';
    
    // Estados mejorados con lógica de intentos
    if (estado === 'activo') return 'success'; // Rindiendo actualmente
    if (estado === 'inactivo' && intentosDisponibles > 0) return 'warning'; // Puede reiniciar
    if (estado === 'finalizado' && intentosDisponibles > 0) return 'warning'; // Finalizado pero puede reiniciar
    if (!haIniciado || estado === 'pendiente') return 'info'; // Sin iniciar
    
    return 'secondary'; // Por defecto
}

// Función para obtener el texto del estado
function getEstadoText(estaActivo, estado, haIniciado, intentosDisponibles) {
    // Estados mejorados con lógica de intentos
    if (estado === 'activo') return 'Rindiendo';
    if (estado === 'inactivo' && intentosDisponibles > 0) return 'Puede reiniciar';
    if (estado === 'finalizado' && intentosDisponibles === 0) return 'Finalizado';
    if (estado === 'finalizado' && intentosDisponibles > 0) return 'Puede reiniciar';
    if (estado === 'suspendido') return 'Suspendido';
    if (!haIniciado || estado === 'pendiente') return 'Pendiente';
    
    return 'Estado desconocido';
}

// Función para generar el HTML de una fila
function generarFilaMonitoreo(monitoreo) {
    // Determinar el contenido de la columna de progreso/puntaje
    let progresoPuntajeContent = '';
    
    if (monitoreo.estado === 'finalizado' && monitoreo.intentos_disponibles === 0) {
        // Participante finalizó definitivamente - mostrar puntaje si está disponible
        if (monitoreo.tiene_resultado_completado) {
            const puntajeColor = monitoreo.puntaje >= 7 ? 'success' : 
                                monitoreo.puntaje >= 5 ? 'warning' : 'danger';
            progresoPuntajeContent = `
                <div class="text-center">
                    <strong class="text-${puntajeColor}">${monitoreo.puntaje_numerico || 0}</strong><br>
                    <small class="text-muted">${monitoreo.puntaje || 0}%</small>
                </div>
            `;
        } else {
            progresoPuntajeContent = `
                <div class="text-center">
                    <span class="badge bg-secondary">
                        <i class="bi bi-check-circle"></i> Completado
                    </span>
                </div>
            `;
        }
    } else if ((monitoreo.estado === 'finalizado' || monitoreo.estado === 'inactivo') && monitoreo.intentos_disponibles > 0) {
        // Participante terminó pero puede reiniciar
        progresoPuntajeContent = `
            <div class="text-center">
                <span class="badge bg-warning">
                    <i class="bi bi-arrow-clockwise"></i> Puede reiniciar
                </span>
            </div>
        `;
    } else if (!monitoreo.ha_iniciado || monitoreo.estado === 'pendiente') {
        // Participante no ha iniciado la evaluación
        progresoPuntajeContent = `
            <div class="text-center">
                <span class="badge bg-info">
                    <i class="bi bi-clock"></i> Sin iniciar
                </span>
            </div>
        `;
    } else {
        // Participante está rindiendo - mostrar progreso
        const porcentaje = monitoreo.porcentaje_avance || 0;
        progresoPuntajeContent = `
            <div class="progress" style="height: 20px;">
                <div class="progress-bar ${porcentaje > 0 ? 'bg-primary' : 'bg-light'}" role="progressbar" 
                     style="width: ${porcentaje}%" 
                     aria-valuenow="${porcentaje}" 
                     aria-valuemin="0" aria-valuemax="100">
                    ${porcentaje}%
                </div>
            </div>
            <small class="text-muted">
                ${monitoreo.preguntas_respondidas || 0} respondidas / ${monitoreo.preguntas_revisadas || 0} revisadas
            </small>
        `;
    }
    
    return `
        <td>
            <strong>${monitoreo.participante_nombre}</strong><br>
            <small class="text-muted">${monitoreo.participante_cedula}</small>
        </td>
        <td>
            <span class="badge bg-${getEstadoColor(monitoreo.esta_activo, monitoreo.estado, monitoreo.ha_iniciado, monitoreo.intentos_disponibles)}">
                ${getEstadoText(monitoreo.esta_activo, monitoreo.estado, monitoreo.ha_iniciado, monitoreo.intentos_disponibles)}
            </span>
        </td>
        <td>${progresoPuntajeContent}</td>
        <td>
            ${(() => {
                // Mostrar última actividad según el estado
                if (!monitoreo.ha_iniciado || monitoreo.estado === 'pendiente') {
                    return '<span class="text-muted"><i class="bi bi-dash-circle"></i> Sin iniciar</span>';
                } else if (monitoreo.ultima_actividad) {
                    const fechaActividad = new Date(monitoreo.ultima_actividad);
                    const ahora = new Date();
                    const diferencia = Math.floor((ahora - fechaActividad) / 60000); // minutos
                    
                    let colorActividad = 'success';
                    if (diferencia > 10) colorActividad = 'danger';
                    else if (diferencia > 5) colorActividad = 'warning';
                    
                    return `<span class="text-${colorActividad}">
                        <i class="bi bi-clock"></i> ${fechaActividad.toLocaleTimeString()}
                        ${diferencia > 0 ? `<br><small class="text-muted">Hace ${diferencia} min</small>` : ''}
                    </span>`;
                } else {
                    return '<span class="text-warning"><i class="bi bi-exclamation-triangle"></i> Sin registro</span>';
                }
            })()}
        </td>
        <td>
            ${(() => {
                // Calcular los intentos usando la lógica del modelo
                const intentosUsados = monitoreo.intentos_usados || 0;
                const intentosDisponibles = monitoreo.intentos_disponibles || 0;
                const intentosTotales = intentosUsados + intentosDisponibles;
                const tieneIntentos = intentosDisponibles > 0;
                
                // Badge color según si tiene intentos disponibles
                const badgeColor = tieneIntentos ? 'bg-success' : 'bg-danger';
                
                return `<span class="badge ${badgeColor}" title="Disponibles/Total">
                    ${intentosDisponibles}/${intentosTotales}
                </span>`;
            })()}
        </td>
        <td>
            ${(() => {
                // Mostrar cambios de pestañas con colores según la cantidad
                const cambiosActuales = monitoreo.cambios_pestana_actuales || 0;
                const cambiosMaximo = monitoreo.cambios_pestana_maximo || 3;
                
                let badgeColor = 'bg-success';
                if (cambiosActuales >= cambiosMaximo) {
                    badgeColor = 'bg-danger';
                } else if (cambiosActuales > cambiosMaximo / 2) {
                    badgeColor = 'bg-warning text-dark';
                }
                
                return `<span class="badge ${badgeColor}" title="Cambios/Máximo">
                    ${cambiosActuales}/${cambiosMaximo}
                </span>`;
            })()}
        </td>
        <td>
            ${monitoreo.alertas_count > 0 ? 
                `<span class="badge bg-danger">${monitoreo.alertas_count}</span>` : 
                '<span class="badge bg-success">0</span>'
            }
        </td>
        <td>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-info" 
                        onclick="verDetalles(${monitoreo.id})" 
                        title="Ver detalles">
                    <i class="bi bi-eye"></i>
                </button>
                ${(() => {
                    // Lógica mejorada basada en los datos del modelo
                    console.log(`Participante: ${monitoreo.participante_nombre}, Estado: ${monitoreo.estado}, Intentos disponibles: ${monitoreo.intentos_disponibles}`);
                    
                    // Si tiene intentos disponibles, pueden pasar diferentes cosas:
                    if (monitoreo.intentos_disponibles > 0) {
                        // Si no ha iniciado (pendiente)
                        if (monitoreo.estado === 'pendiente' || !monitoreo.ha_iniciado) {
                            return `<button type="button" class="btn btn-outline-info" disabled title="Esperando que inicie">
                                <i class="bi bi-hourglass-split"></i> Esperando
                            </button>`;
                        }
                        
                        // Si está rindiendo actualmente
                        if (monitoreo.estado === 'activo') {
                            return `
                                <button type="button" class="btn btn-outline-warning" 
                                        onclick="agregarAlerta(${monitoreo.id})" 
                                        title="Agregar alerta">
                                    <i class="bi bi-exclamation-triangle"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger" 
                                        onclick="reducirCambiosPestana(${monitoreo.participante_id}, '${monitoreo.participante_nombre}', ${monitoreo.cambios_pestana_actuales || 0}, ${monitoreo.cambios_pestana_maximo || 3})" 
                                        title="Reducir cambios de pestañas">
                                    <i class="bi bi-dash-circle"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger" 
                                        onclick="finalizarEvaluacion(${monitoreo.id}, '${monitoreo.participante_nombre}')" 
                                        title="Finalizar evaluación">
                                    <i class="bi bi-stop-circle"></i>
                                </button>
                            `;
                        }
                        
                        // Si está inactivo o finalizado pero tiene intentos disponibles (puede reiniciar)
                        if (monitoreo.estado === 'inactivo' || (monitoreo.estado === 'finalizado' && monitoreo.intentos_disponibles > 0)) {
                            return `<button type="button" class="btn btn-outline-success" disabled title="Puede reiniciar cuando quiera">
                                <i class="bi bi-play-circle"></i> Disponible
                            </button>`;
                        }
                    }
                    
                    // Si NO tiene intentos disponibles (agotó sus intentos)
                    // Solo mostrar botón de nuevo intento
                    const intentosTotales = (monitoreo.intentos_usados || 0) + (monitoreo.intentos_disponibles || 0);
                    return `<button type="button" class="btn btn-outline-success" 
                            onclick="darNuevoIntento(${monitoreo.participante_id}, '${monitoreo.participante_nombre}', ${monitoreo.intentos_usados || 0}, ${intentosTotales})" 
                            title="Dar nuevo intento">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>`;
                })()}
            </div>
        </td>
    `;
}

// Función para mostrar notificaciones de cambios importantes
function notificarCambioEstado(monitoreo, estadoAnterior) {
    const nombre = monitoreo.participante_nombre;
    
    if (!estadoAnterior) return; // Primera carga
    
    // Detectar cambios importantes
    if (estadoAnterior.estado === 'pendiente' && monitoreo.ha_iniciado) {
        showDynamicToast({
            type: 'info',
            title: 'Participante iniciado',
            message: `${nombre} ha comenzado la evaluación`
        });
    } else if ((estadoAnterior.estado === 'finalizado' || estadoAnterior.estado === 'inactivo') && monitoreo.estado === 'activo') {
        showDynamicToast({
            type: 'info',
            title: 'Nuevo intento iniciado',
            message: `${nombre} ha iniciado un nuevo intento de evaluación`
        });
    } else if (monitoreo.alertas_count > (estadoAnterior.alertas_count || 0)) {
        showDynamicToast({
            type: 'warning',
            title: 'Nueva alerta',
            message: `Se agregó una alerta para ${nombre}`
        });
    } else if (estadoAnterior.esta_activo && !monitoreo.esta_activo && monitoreo.estado !== 'finalizado') {
        showDynamicToast({
            type: 'warning',
            title: 'Participante inactivo',
            message: `${nombre} lleva más de 5 minutos sin actividad`
        });
    }
}

// Función para detectar cambios en los datos
function hasMonitoreoChanged(current, previous) {
    if (!previous) return true;
    
    // Comparar campos clave que indican cambios importantes
    return (
        current.estado !== previous.estado ||
        current.ha_iniciado !== previous.ha_iniciado ||
        current.esta_activo !== previous.esta_activo ||
        current.porcentaje_avance !== previous.porcentaje_avance ||
        current.preguntas_respondidas !== previous.preguntas_respondidas ||
        current.alertas_count !== previous.alertas_count ||
        current.ultima_actividad !== previous.ultima_actividad ||
        current.intentos_usados !== previous.intentos_usados ||
        current.intentos_disponibles !== previous.intentos_disponibles ||
        current.cambios_pestana_actuales !== previous.cambios_pestana_actuales
    );
}

// Función mejorada para cargar monitoreo en tiempo real
function cargarMonitoreo() {
    console.log('Cargando datos del monitoreo...');
    
    fetch(`/evaluacion/${evaluacionId}/monitoreo/estado/`)
        .then(response => {
            console.log('Respuesta recibida:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Datos recibidos:', data);
            
            if (!data.monitoreos || !Array.isArray(data.monitoreos)) {
                console.error('Formato de datos inválido:', data);
                throw new Error('Datos de monitoreo inválidos');
            }
            
            const tbody = document.getElementById('tbody-monitoreo');
            
            // Si no hay datos anteriores, es la primera carga - mostrar todos
            const isFirstLoad = Object.keys(lastMonitoreoData).length === 0;
            
            console.log(`${isFirstLoad ? 'Primera carga' : 'Actualización'} - ${data.monitoreos.length} participantes`);
            
            if (isFirstLoad) {
                // Primera carga - limpiar tabla y cargar todos los registros
                tbody.innerHTML = '';
                console.log('Primera carga del monitoreo');
                
                data.monitoreos.forEach(monitoreo => {
                    const row = document.createElement('tr');
                    row.id = `monitoreo-row-${monitoreo.id}`;
                    row.innerHTML = generarFilaMonitoreo(monitoreo);
                    tbody.appendChild(row);
                    
                    // Guardar en cache
                    lastMonitoreoData[monitoreo.id] = { ...monitoreo };
                });
            } else {
                // Actualizaciones posteriores - solo cambiar filas modificadas
                data.monitoreos.forEach(monitoreo => {
                    const rowId = `monitoreo-row-${monitoreo.id}`;
                    let existingRow = document.getElementById(rowId);
                    
                    // Verificar si hay cambios
                    const hasChanged = hasMonitoreoChanged(monitoreo, lastMonitoreoData[monitoreo.id]);
                    
                    if (hasChanged) {
                        // Notificar cambios importantes si no es la primera carga
                        if (lastMonitoreoData[monitoreo.id]) {
                            notificarCambioEstado(monitoreo, lastMonitoreoData[monitoreo.id]);
                        }
                        
                        // Crear o actualizar la fila
                        if (existingRow) {
                            // Actualizar fila existente con animación
                            existingRow.classList.add('fila-actualizada');
                            existingRow.style.background = '#fff3cd'; // Highlight amarillo
                            existingRow.innerHTML = generarFilaMonitoreo(monitoreo);
                            
                            // Remover highlight y animación después de 1 segundo
                            setTimeout(() => {
                                existingRow.style.background = '';
                                existingRow.classList.remove('fila-actualizada');
                            }, 1000);
                            
                            console.log(`Fila actualizada: ${monitoreo.participante_nombre} - Estado: ${monitoreo.estado}`);
                        } else {
                            // Crear nueva fila (participante nuevo agregado)
                            const row = document.createElement('tr');
                            row.id = rowId;
                            row.innerHTML = generarFilaMonitoreo(monitoreo);
                            tbody.appendChild(row);
                            
                            console.log(`Nueva fila agregada: ${monitoreo.participante_nombre}`);
                        }
                    }
                    
                    // Actualizar cache
                    lastMonitoreoData[monitoreo.id] = { ...monitoreo };
                });
            }
            
            // Actualizar timestamp
            document.getElementById('last-update').textContent = 
                new Date(data.timestamp).toLocaleTimeString();
        })
        .catch(error => {
            console.error('Error al cargar monitoreo:', error);
            // En caso de error, mostrar mensaje en la tabla
            const tbody = document.getElementById('tbody-monitoreo');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        Error al cargar los datos del monitoreo. Verificando conexión...
                    </td>
                </tr>
            `;
        });
}

// Función para finalizar evaluación
function finalizarEvaluacion(monitoreoId, participanteNombre) {
    currentMonitoreoId = monitoreoId;
    document.getElementById('participante-nombre').textContent = participanteNombre;
    document.getElementById('motivo-finalizacion').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('modalFinalizar'));
    modal.show();
}

// Función para agregar alerta
function agregarAlerta(monitoreoId) {
    currentMonitoreoId = monitoreoId;
    document.getElementById('tipo-alerta').value = 'comportamiento';
    document.getElementById('severidad-alerta').value = 'media';
    document.getElementById('descripcion-alerta').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('modalAlerta'));
    modal.show();
}

// Función para ver detalles
function verDetalles(monitoreoId) {
    window.location.href = `/monitoreo/${monitoreoId}/detalle/`;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    console.log('Iniciando monitoreo para evaluación ID:', evaluacionId);
    
    // Cargar datos iniciales
    cargarMonitoreo();
    
    // Configurar auto-refresh
    const autoRefreshCheckbox = document.getElementById('auto-refresh');
    
    function toggleAutoRefresh() {
        if (autoRefreshCheckbox.checked) {
            // Actualización más frecuente para monitoreo en tiempo real
            autoRefreshInterval = setInterval(cargarMonitoreo, 5000); // 5 segundos
            console.log('Monitoreo en tiempo real activado - actualización cada 5 segundos');
        } else {
            clearInterval(autoRefreshInterval);
            console.log('Monitoreo en tiempo real desactivado');
        }
    }
    
    autoRefreshCheckbox.addEventListener('change', toggleAutoRefresh);
    toggleAutoRefresh(); // Iniciar auto-refresh
    
    // Event listener para actualizar el nuevo total de intentos dinámicamente
    document.getElementById('cantidad-intentos').addEventListener('change', actualizarNuevoTotal);
    
    // Event listener para actualizar el nuevo total de cambios dinámicamente  
    document.getElementById('cantidad-reducir').addEventListener('change', actualizarNuevoTotalCambios);
    
    // Confirmar finalización
    document.getElementById('btn-confirmar-finalizar').addEventListener('click', function() {
        const motivo = document.getElementById('motivo-finalizacion').value;
        if (!motivo.trim()) {
            showDynamicToast({
                type: 'warning',
                title: 'Advertencia',
                message: 'Por favor, ingrese un motivo para la finalización.'
            });
            return;
        }
        
        fetch(`/evaluacion/${evaluacionId}/monitoreo/finalizar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                monitoreo_id: currentMonitoreoId,
                motivo: motivo
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('modalFinalizar')).hide();
                cargarMonitoreo();
                // Mostrar notificación de éxito usando la función global
                showDynamicToast({
                    type: 'success',
                    title: 'Éxito',
                    message: data.message
                });
            } else {
                showDynamicToast({
                    type: 'danger',
                    title: 'Error',
                    message: data.error
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showDynamicToast({
                type: 'danger',
                title: 'Error',
                message: 'Error al finalizar la evaluación'
            });
        });
    });
    
    // Confirmar alerta
    document.getElementById('btn-confirmar-alerta').addEventListener('click', function() {
        const tipoAlerta = document.getElementById('tipo-alerta').value;
        const severidad = document.getElementById('severidad-alerta').value;
        const descripcion = document.getElementById('descripcion-alerta').value;
        
        if (!descripcion.trim()) {
            showDynamicToast({
                type: 'warning',
                title: 'Advertencia',
                message: 'Por favor, ingrese una descripción para la alerta.'
            });
            return;
        }
        
        fetch(`/monitoreo/${currentMonitoreoId}/alerta/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                tipo_alerta: tipoAlerta,
                severidad: severidad,
                descripcion: descripcion
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('modalAlerta')).hide();
                cargarMonitoreo();
                // Mostrar notificación de éxito usando la función global
                showDynamicToast({
                    type: 'success',
                    title: 'Éxito',
                    message: data.message
                });
            } else {
                showDynamicToast({
                    type: 'danger',
                    title: 'Error',
                    message: data.error
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showDynamicToast({
                type: 'danger',
                title: 'Error',
                message: 'Error al agregar la alerta'
            });
        });
    });
    
    // Confirmar nuevo intento
    document.getElementById('btn-confirmar-nuevo-intento').addEventListener('click', function() {
        const participanteId = window.currentParticipanteId;
        const nombreParticipante = window.currentParticipanteNombre;
        const cantidadIntentos = document.getElementById('cantidad-intentos').value;
        
        if (!participanteId) {
            showDynamicToast({
                type: 'danger',
                title: 'Error',
                message: 'No se ha seleccionado un participante válido.'
            });
            return;
        }
        
        if (!cantidadIntentos || cantidadIntentos < 1) {
            showDynamicToast({
                type: 'warning',
                title: 'Advertencia',
                message: 'Por favor, ingrese una cantidad válida de intentos.'
            });
            return;
        }
        
        fetch(`/evaluacion/{{ evaluacion.pk }}/dar-nuevo-intento/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                participante_id: participanteId,
                cantidad_intentos: parseInt(cantidadIntentos)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('modalNuevoIntento')).hide();
                cargarMonitoreo();
                showDynamicToast({
                    type: 'success',
                    title: 'Éxito',
                    message: data.message
                });
                // Limpiar variables globales
                window.currentParticipanteId = null;
                window.currentParticipanteNombre = null;
            } else {
                showDynamicToast({
                    type: 'danger',
                    title: 'Error',
                    message: data.error
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showDynamicToast({
                type: 'danger',
                title: 'Error',
                message: 'Error al procesar el nuevo intento'
            });
        });
    });
    
    // Confirmar reducción de cambios de pestañas
    document.getElementById('btn-confirmar-reducir').addEventListener('click', function() {
        const participanteId = window.currentParticipanteIdReducir;
        const nombreParticipante = window.currentParticipanteNombreReducir;
        const cantidadReducir = document.getElementById('cantidad-reducir').value;
        
        if (!participanteId) {
            showDynamicToast({
                type: 'danger',
                title: 'Error',
                message: 'No se ha seleccionado un participante válido.'
            });
            return;
        }
        
        if (!cantidadReducir || cantidadReducir < 1) {
            showDynamicToast({
                type: 'warning',
                title: 'Advertencia',
                message: 'Por favor, seleccione una cantidad válida para reducir.'
            });
            return;
        }
        
        fetch(`/evaluacion/{{ evaluacion.pk }}/reducir-cambios-pestana/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                participante_id: participanteId,
                cantidad_reduccion: parseInt(cantidadReducir)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('modalReducirCambiosPestana')).hide();
                cargarMonitoreo();
                showDynamicToast({
                    type: 'success',
                    title: 'Éxito',
                    message: data.message
                });
                // Limpiar variables globales
                window.currentParticipanteIdReducir = null;
                window.currentParticipanteNombreReducir = null;
                window.currentCambiosActuales = null;
            } else {
                showDynamicToast({
                    type: 'danger',
                    title: 'Error',
                    message: data.error
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showDynamicToast({
                type: 'danger',
                title: 'Error',
                message: 'Error al procesar la reducción de cambios'
            });
        });
    });
});

// Función para dar nuevo intento (fuera del DOMContentLoaded para ser accesible globalmente)
function darNuevoIntento(participanteId, nombreParticipante, intentosUsados = 0, intentosTotales = 1) {
    // Guardar los datos en variables globales para usar en el modal
    window.currentParticipanteId = participanteId;
    window.currentParticipanteNombre = nombreParticipante;
    
    // Actualizar el contenido del modal
    document.getElementById('nombre-participante-intento').textContent = nombreParticipante;
    document.getElementById('intentos-usados').textContent = intentosUsados;
    document.getElementById('intentos-totales').textContent = intentosTotales;
    
    // Resetear el select a 1 intento adicional
    document.getElementById('cantidad-intentos').value = "1";
    
    // Calcular y mostrar el nuevo total
    actualizarNuevoTotal();
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('modalNuevoIntento'));
    modal.show();
}

// Función para reducir cambios de pestañas (nueva funcionalidad)
function reducirCambiosPestana(participanteId, nombreParticipante, cambiosActuales = 0, cambiosMaximo = 3) {
    // Validar que el participante tiene cambios de pestañas para reducir
    if (cambiosActuales === 0) {
        showDynamicToast({
            type: 'warning',
            title: 'Sin cambios',
            message: `${nombreParticipante} no ha realizado cambios de pestañas.`
        });
        return;
    }
    
    // Guardar los datos en variables globales para usar en el modal
    window.currentParticipanteIdReducir = participanteId;
    window.currentParticipanteNombreReducir = nombreParticipante;
    window.currentCambiosActuales = cambiosActuales;
    
    // Actualizar el contenido del modal
    document.getElementById('nombre-participante-reducir').textContent = nombreParticipante;
    document.getElementById('cambios-actuales').textContent = cambiosActuales;
    document.getElementById('cambios-maximo').textContent = cambiosMaximo;
    
    // Configurar el select con opciones válidas (no se puede reducir más de lo que tiene)
    const selectReducir = document.getElementById('cantidad-reducir');
    selectReducir.innerHTML = '';
    for (let i = 1; i <= Math.min(cambiosActuales, 3); i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `${i} cambio${i > 1 ? 's' : ''}`;
        if (i === 1) option.selected = true;
        selectReducir.appendChild(option);
    }
    
    // Calcular y mostrar el nuevo total
    actualizarNuevoTotalCambios();
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('modalReducirCambiosPestana'));
    modal.show();
}

// Función para actualizar el nuevo total dinámicamente
function actualizarNuevoTotal() {
    const intentosTotales = parseInt(document.getElementById('intentos-totales').textContent) || 0;
    const cantidadAdicional = parseInt(document.getElementById('cantidad-intentos').value) || 0;
    const nuevoTotal = intentosTotales + cantidadAdicional;
    
    const nuevoTotalElement = document.getElementById('nuevo-total');
    nuevoTotalElement.textContent = nuevoTotal;
    
    // Efecto visual de actualización
    nuevoTotalElement.style.transform = 'scale(1.2)';
    nuevoTotalElement.style.transition = 'transform 0.2s ease';
    setTimeout(() => {
        nuevoTotalElement.style.transform = 'scale(1)';
    }, 200);
}

// Función para actualizar el nuevo total de cambios dinámicamente
function actualizarNuevoTotalCambios() {
    const cambiosActuales = window.currentCambiosActuales || 0;
    const cantidadReducir = parseInt(document.getElementById('cantidad-reducir').value) || 0;
    const nuevoTotal = Math.max(0, cambiosActuales - cantidadReducir);
    
    const nuevoTotalElement = document.getElementById('nuevo-total-cambios');
    nuevoTotalElement.textContent = nuevoTotal;
    
    // Cambiar color según el nuevo total
    nuevoTotalElement.className = 'badge fs-6';
    if (nuevoTotal === 0) {
        nuevoTotalElement.className += ' bg-success';
    } else if (nuevoTotal === 1) {
        nuevoTotalElement.className += ' bg-warning';
    } else {
        nuevoTotalElement.className += ' bg-danger';
    }
    
    // Efecto visual de actualización
    nuevoTotalElement.style.transform = 'scale(1.2)';
    nuevoTotalElement.style.transition = 'transform 0.2s ease';
    setTimeout(() => {
        nuevoTotalElement.style.transform = 'scale(1)';
    }, 200);
}


</script>
{% endblock %} 